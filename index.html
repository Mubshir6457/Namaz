<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eaeaea;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            color: #2c3e50;
            border-bottom: 3px solid #4caf50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .date-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .date-section h3 {
            margin-bottom: 10px;
            color: #2e7d32;
        }
        
        input[type="date"], input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn-present {
            background: #4caf50;
            color: white;
        }
        
        .btn-present:hover {
            background: #45a049;
        }
        
        .btn-absent {
            background: #f44336;
            color: white;
        }
        
        .btn-absent:hover {
            background: #da190b;
        }
        
        .btn-info {
            background: #2196f3;
            color: white;
        }
        
        .btn-info:hover {
            background: #1976d2;
        }
        
        .btn-success {
            background: #388e3c;
            color: white;
        }
        
        .btn-success:hover {
            background: #2e7d32;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #d32f2f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b71c1c;
        }
        
        .attendance-list {
            margin-top: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        th {
            background: #c8e6c9;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f8e9;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .status-present {
            background: #4caf50;
            color: white;
        }
        
        .status-absent {
            background: #f44336;
            color: white;
        }
        
        .status-leave {
            background: #ff9800;
            color: white;
        }
        
        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2e7d32;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .checkbox-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .fine-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .fine-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .fine-input-group input, .fine-input-group select {
            flex: 1;
        }
        
        .fine-amount {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .fine-paid {
            color: #4caf50;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        .danger-zone {
            background: #ffebee;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #ffcdd2;
        }
        
        .danger-zone h3 {
            color: #d32f2f;
            margin-bottom: 15px;
        }
        
        .danger-zone p {
            margin-bottom: 15px;
            color: #666;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .confirmation-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .confirmation-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .confirm-btn {
            background: #d32f2f;
            color: white;
        }
        
        .confirm-btn:hover {
            background: #b71c1c;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        
        .cancel-btn:hover {
            background: #5a6268;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 5px;
            }
            
            .attendance-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .fine-input-group {
                flex-direction: column;
            }
            
            .fine-input-group input, .fine-input-group select {
                width: 100%;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Student Attendance System</h1>
            <p>Mark attendance and manage student fines</p>
        </header>
        
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('attendance')">üìÖ Mark Attendance</button>
            <button class="tab-btn" onclick="showTab('fines')">üí∞ Manage Fines</button>
            <button class="tab-btn" onclick="showTab('reports')">üìä Reports</button>
            <button class="tab-btn" onclick="showTab('danger')">‚ö†Ô∏è Danger Zone</button>
        </div>
        
        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content active">
            <div class="date-section">
                <h3>üìÖ Select Date</h3>
                <input type="date" id="attendanceDate" value="">
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-present" onclick="markAllPresent()">‚úÖ Mark All Present</button>
                <button class="btn btn-absent" onclick="markAllAbsent()">‚ùå Mark All Absent</button>
                <button class="btn btn-info" onclick="loadStudentsFromFirebase()">üîÑ Load Students</button>
                <button class="btn btn-success" onclick="saveAttendanceToFirebase()">üíæ Save Attendance</button>
            </div>
            
            <div id="attendanceStats" class="attendance-stats"></div>
            
            <div id="attendanceList" class="attendance-list"></div>
        </div>
        
        <!-- Fines Tab -->
        <div id="fines" class="tab-content">
            <h2>üí∞ Manual Fine Management</h2>
            <p>Add or adjust fines for individual students</p>
            
            <div class="fine-section">
                <h3>‚ûï Add Fine to Student</h3>
                <div class="fine-input-group">
                    <select id="fineStudent">
                        <option value="">Select Student</option>
                    </select>
                    <input type="number" id="fineAmount" placeholder="Fine Amount (Rs)" min="0">
                    <input type="text" id="fineReason" placeholder="Reason for Fine">
                    <button class="btn btn-warning" onclick="addManualFine()">‚ûï Add Fine</button>
                </div>
            </div>
            
            <div class="fine-section">
                <h3>üìã Student Fines Summary</h3>
                <div id="finesList" class="attendance-list"></div>
                <button class="btn btn-info" onclick="loadFinesSummary()">üîÑ Refresh Fines</button>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>üìä Attendance & Fines Report</h2>
            
            <div class="quick-actions">
                <button class="btn btn-info" onclick="generateAttendanceReport()">üìÑ Generate Report</button>
                <button class="btn btn-warning" onclick="calculateAutomaticFines()">üí∞ Calculate Auto Fines</button>
                <button class="btn btn-success" onclick="markAllFinesPaid()">‚úÖ Mark All Fines Paid</button>
            </div>
            
            <div id="reportResults" class="attendance-list"></div>
        </div>
        
        <!-- Danger Zone Tab -->
        <div id="danger" class="tab-content">
            <h2 style="color: #d32f2f;">‚ö†Ô∏è Danger Zone</h2>
            <p>Critical operations that cannot be undone</p>
            
            <div class="danger-zone">
                <h3>üóëÔ∏è Delete All Data</h3>
                <p><strong>Warning:</strong> This action will permanently delete ALL attendance records, fines, and payment data. Only student information will be preserved.</p>
                <p>This operation cannot be undone!</p>
                
                <div class="quick-actions">
                    <button class="btn btn-danger" onclick="showDeleteAllConfirmation()">üö® DELETE ALL DATA</button>
                </div>
            </div>
            
            <div class="danger-zone">
                <h3>üìä Data Status</h3>
                <div id="dataStatus" class="attendance-list"></div>
                <button class="btn btn-info" onclick="checkDataStatus()">üîÑ Check Data Status</button>
            </div>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
            authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
            databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
            projectId: "faizan-e-raza-madarsa-8c743",
            storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
            messagingSenderId: "659467130617",
            appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global variables
        let students = [];
        let attendanceData = {};
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            document.getElementById('attendanceDate').valueAsDate = new Date();
            
            // Load students from Firebase
            loadStudentsFromFirebase();
        });
        
        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'fines') {
                loadFinesStudentDropdown();
                loadFinesSummary();
            } else if (tabName === 'reports') {
                generateAttendanceReport();
            } else if (tabName === 'danger') {
                checkDataStatus();
            }
        }
        
        // Load students from Firebase
        async function loadStudentsFromFirebase() {
            try {
                showMessage("Loading students...", "info");
                document.body.classList.add('loading');
                
                const snapshot = await database.ref('students').once('value');
                
                if (!snapshot.exists()) {
                    showMessage("No students found in database. Please add students first.", "error");
                    document.body.classList.remove('loading');
                    return;
                }
                
                students = [];
                snapshot.forEach(childSnapshot => {
                    const student = childSnapshot.val();
                    students.push(student);
                });
                
                // Load attendance data for the selected date
                await loadAttendanceData();
                
                // Display students
                displayStudents();
                
                document.body.classList.remove('loading');
                showMessage("Students loaded successfully!", "success");
                
            } catch (error) {
                document.body.classList.remove('loading');
                showMessage("Error loading students: " + error.message, "error");
            }
        }
        
        // Load attendance data for the selected date
        async function loadAttendanceData() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                return;
            }
            
            try {
                const snapshot = await database.ref('attendance/' + date).once('value');
                
                // Reset attendance data
                attendanceData = {};
                
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const attendanceRecord = childSnapshot.val();
                        attendanceData[attendanceRecord.roll] = attendanceRecord.status;
                    });
                } else {
                    // Initialize with all students as Present
                    students.forEach(student => {
                        attendanceData[student.roll] = 'Present';
                    });
                }
                
            } catch (error) {
                console.error("Error loading attendance data:", error);
            }
        }
        
        // Display students in the attendance list
        function displayStudents() {
            const attendanceList = document.getElementById("attendanceList");
            
            if (students.length === 0) {
                attendanceList.innerHTML = "<p>No students found. Please add students first.</p>";
                return;
            }
            
            let html = "<table><tr><th>Roll No</th><th>Student Name</th><th>Status</th></tr>";
            
            students.forEach(student => {
                // Get current status or default to Present
                const currentStatus = attendanceData[student.roll] || 'Present';
                
                html += `<tr>
                    <td>${student.roll}</td>
                    <td>${student.name}</td>
                    <td>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="radio" id="present_${student.roll}" name="status_${student.roll}" 
                                       value="Present" ${currentStatus === 'Present' ? 'checked' : ''}
                                       onchange="setStudentStatus('${student.roll}', 'Present')">
                                <label for="present_${student.roll}">Present</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="absent_${student.roll}" name="status_${student.roll}" 
                                       value="Absent" ${currentStatus === 'Absent' ? 'checked' : ''}
                                       onchange="setStudentStatus('${student.roll}', 'Absent')">
                                <label for="absent_${student.roll}">Absent</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="leave_${student.roll}" name="status_${student.roll}" 
                                       value="Leave" ${currentStatus === 'Leave' ? 'checked' : ''}
                                       onchange="setStudentStatus('${student.roll}', 'Leave')">
                                <label for="leave_${student.roll}">Leave</label>
                            </div>
                        </div>
                    </td>
                </tr>`;
            });
            
            html += "</table>";
            attendanceList.innerHTML = html;
            
            // Update attendance stats
            updateAttendanceStats();
        }
        
        // Set individual student status
        function setStudentStatus(roll, status) {
            // Update attendance data
            attendanceData[roll] = status;
            
            // Update stats
            updateAttendanceStats();
        }
        
        // Mark all students present
        function markAllPresent() {
            students.forEach(student => {
                setStudentStatus(student.roll, 'Present');
                document.getElementById(`present_${student.roll}`).checked = true;
            });
            showMessage("All students marked as Present!", "success");
        }
        
        // Mark all students absent
        function markAllAbsent() {
            students.forEach(student => {
                setStudentStatus(student.roll, 'Absent');
                document.getElementById(`absent_${student.roll}`).checked = true;
            });
            showMessage("All students marked as Absent!", "success");
        }
        
        // Update attendance statistics
        function updateAttendanceStats() {
            const totalStudents = students.length;
            const presentCount = Object.values(attendanceData).filter(status => status === 'Present').length;
            const absentCount = Object.values(attendanceData).filter(status => status === 'Absent').length;
            const leaveCount = Object.values(attendanceData).filter(status => status === 'Leave').length;
            
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #4caf50;">${presentCount}</div>
                    <div class="stat-label">Present</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #f44336;">${absentCount}</div>
                    <div class="stat-label">Absent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ff9800;">${leaveCount}</div>
                    <div class="stat-label">Leave</div>
                </div>
            `;
            
            document.getElementById('attendanceStats').innerHTML = statsHtml;
        }
        
        // Save attendance to Firebase
        async function saveAttendanceToFirebase() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                showMessage("Please select a date!", "error");
                return;
            }
            
            if (Object.keys(attendanceData).length === 0) {
                showMessage("Please mark attendance for at least one student!", "error");
                return;
            }
            
            try {
                showMessage("Saving attendance...", "info");
                document.body.classList.add('loading');
                
                // Prepare data for Firebase
                const updates = {};
                
                students.forEach(student => {
                    const status = attendanceData[student.roll] || 'Present';
                    updates[`attendance/${date}/${student.roll}`] = {
                        roll: student.roll,
                        name: student.name,
                        status: status,
                        date: date,
                        timestamp: new Date().toISOString()
                    };
                });
                
                // Save to Firebase
                await database.ref().update(updates);
                
                document.body.classList.remove('loading');
                showMessage(`Attendance saved successfully for ${date}!`, "success");
                
            } catch (error) {
                document.body.classList.remove('loading');
                showMessage("Error saving attendance: " + error.message, "error");
            }
        }
        
        // ========== FINE MANAGEMENT FUNCTIONS ==========
        
        // Load student dropdown for fines
        function loadFinesStudentDropdown() {
            const dropdown = document.getElementById('fineStudent');
            dropdown.innerHTML = '<option value="">Select Student</option>';
            
            students.forEach(student => {
                dropdown.innerHTML += `<option value="${student.roll}">${student.roll} - ${student.name}</option>`;
            });
        }
        
        // Add manual fine to student
        async function addManualFine() {
            const roll = document.getElementById('fineStudent').value;
            const amount = parseFloat(document.getElementById('fineAmount').value);
            const reason = document.getElementById('fineReason').value.trim();
            
            if (!roll || !amount || amount <= 0) {
                showMessage("Please select a student and enter a valid fine amount!", "error");
                return;
            }
            
            try {
                // Get current student data
                const snapshot = await database.ref('students/' + roll).once('value');
                if (!snapshot.exists()) {
                    showMessage("Student not found!", "error");
                    return;
                }
                
                const student = snapshot.val();
                
                // Initialize fines array if it doesn't exist
                if (!student.fines) {
                    student.fines = [];
                }
                
                // Create new fine record
                const newFine = {
                    amount: amount,
                    reason: reason,
                    type: 'manual',
                    date: new Date().toISOString().split('T')[0],
                    timestamp: new Date().toISOString(),
                    id: Date.now().toString()
                };
                
                // Add fine to array
                student.fines.push(newFine);
                
                // Calculate total fine
                const totalFine = student.fines.reduce((sum, fine) => sum + fine.amount, 0);
                
                // Update student in Firebase
                await database.ref('students/' + roll).update({
                    fines: student.fines,
                    totalFine: totalFine
                });
                
                showMessage(`Fine of Rs ${amount} added to ${student.name}!`, "success");
                
                // Reset form
                document.getElementById('fineAmount').value = '';
                document.getElementById('fineReason').value = '';
                
                // Refresh fines summary
                loadFinesSummary();
                
            } catch (error) {
                showMessage("Error adding fine: " + error.message, "error");
            }
        }
        
        // Load fines summary
        async function loadFinesSummary() {
            try {
                const finesList = document.getElementById('finesList');
                finesList.innerHTML = "<p>Loading fines summary...</p>";
                
                const snapshot = await database.ref('students').once('value');
                
                if (!snapshot.exists()) {
                    finesList.innerHTML = "<p>No students found!</p>";
                    return;
                }
                
                let html = "<table><tr><th>Roll No</th><th>Name</th><th>Total Fine</th><th>Fine Details</th><th>Actions</th></tr>";
                
                snapshot.forEach(childSnapshot => {
                    const student = childSnapshot.val();
                    const totalFine = student.totalFine || 0;
                    
                    html += `<tr>
                        <td>${student.roll}</td>
                        <td>${student.name}</td>
                        <td class="fine-amount">Rs ${totalFine}</td>
                        <td>
                            ${student.fines ? student.fines.map(fine => 
                                `<div>Rs ${fine.amount} - ${fine.reason || 'No reason'} (${fine.date})</div>`
                            ).join('') : 'No fines'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-small" onclick="markFinePaid('${student.roll}')">‚úÖ Paid</button>
                                <button class="btn btn-warning btn-small" onclick="adjustFine('${student.roll}')">‚úèÔ∏è Adjust</button>
                            </div>
                        </td>
                    </tr>`;
                });
                
                html += "</table>";
                finesList.innerHTML = html;
                
            } catch (error) {
                document.getElementById("finesList").innerHTML = "<p>Error loading fines: " + error.message + "</p>";
            }
        }
        
        // Mark fine as paid
        async function markFinePaid(roll) {
            try {
                // Update student in Firebase - set totalFine to 0 and clear fines
                await database.ref('students/' + roll).update({
                    totalFine: 0,
                    fines: []
                });
                
                showMessage(`Fine marked as paid for Roll No: ${roll}!`, "success");
                
                // Refresh fines summary
                loadFinesSummary();
                
            } catch (error) {
                showMessage("Error marking fine as paid: " + error.message, "error");
            }
        }
        
        // Adjust fine (simple implementation - in a real app, this would open a modal)
        function adjustFine(roll) {
            const newAmount = prompt(`Enter new fine amount for Roll No ${roll}:`, "0");
            if (newAmount !== null) {
                const amount = parseFloat(newAmount);
                if (!isNaN(amount) && amount >= 0) {
                    updateFineAmount(roll, amount);
                } else {
                    showMessage("Please enter a valid amount!", "error");
                }
            }
        }
        
        // Update fine amount
        async function updateFineAmount(roll, amount) {
            try {
                await database.ref('students/' + roll).update({
                    totalFine: amount
                });
                
                showMessage(`Fine amount updated to Rs ${amount} for Roll No: ${roll}!`, "success");
                
                // Refresh fines summary
                loadFinesSummary();
                
            } catch (error) {
                showMessage("Error updating fine: " + error.message, "error");
            }
        }
        
        // ========== REPORT FUNCTIONS ==========
        
        // Generate attendance report
        async function generateAttendanceReport() {
            try {
                const reportResults = document.getElementById("reportResults");
                reportResults.innerHTML = "<p>Generating report...</p>";
                
                const studentsSnapshot = await database.ref('students').once('value');
                const attendanceSnapshot = await database.ref('attendance').once('value');
                
                if (!studentsSnapshot.exists()) {
                    reportResults.innerHTML = "<p>No Students Found!</p>";
                    return;
                }
                
                let html = "<table><tr><th>Roll No</th><th>Name</th><th>Present</th><th>Absent</th><th>Leaves</th><th>Total Days</th><th>Fine Amount</th><th>Status</th></tr>";
                
                studentsSnapshot.forEach(childSnapshot => {
                    const student = childSnapshot.val();
                    let present = 0;
                    let absent = 0;
                    let totalDays = 0;
                    
                    // Calculate attendance
                    if (attendanceSnapshot.exists()) {
                        attendanceSnapshot.forEach(dateSnap => {
                            const attendanceRecord = dateSnap.val()[student.roll];
                            if (attendanceRecord) {
                                totalDays++;
                                if (attendanceRecord.status === 'Present') {
                                    present++;
                                } else if (attendanceRecord.status === 'Absent') {
                                    absent++;
                                }
                            }
                        });
                    }
                    
                    const totalFine = student.totalFine || 0;
                    const isFinePaid = totalFine === 0;
                    
                    html += `<tr>
                        <td>${student.roll}</td>
                        <td>${student.name}</td>
                        <td>${present}</td>
                        <td>${absent}</td>
                        <td>${totalDays - present - absent}</td>
                        <td>${totalDays}</td>
                        <td class="${isFinePaid ? 'fine-paid' : 'fine-amount'}">Rs ${totalFine}</td>
                        <td>${isFinePaid ? 'Paid ‚úÖ' : 'Pending ‚ùå'}</td>
                    </tr>`;
                });
                
                html += "</table>";
                reportResults.innerHTML = html;
                
            } catch (error) {
                document.getElementById("reportResults").innerHTML = "<p>Error generating report: " + error.message + "</p>";
            }
        }
        
        // Calculate automatic fines based on attendance
        async function calculateAutomaticFines() {
            try {
                showMessage("Calculating automatic fines...", "info");
                
                const studentsSnapshot = await database.ref('students').once('value');
                const attendanceSnapshot = await database.ref('attendance').once('value');
                
                if (!studentsSnapshot.exists()) {
                    showMessage("No students found!", "error");
                    return;
                }
                
                const updates = {};
                
                studentsSnapshot.forEach(childSnapshot => {
                    const student = childSnapshot.val();
                    let absentCount = 0;
                    
                    // Calculate absent days
                    if (attendanceSnapshot.exists()) {
                        attendanceSnapshot.forEach(dateSnap => {
                            const attendanceRecord = dateSnap.val()[student.roll];
                            if (attendanceRecord && attendanceRecord.status === 'Absent') {
                                absentCount++;
                            }
                        });
                    }
                    
                    // Calculate fine (Rs 10 per absence)
                    const autoFine = absentCount * 10;
                    
                    // Initialize fines array if it doesn't exist
                    const currentFines = student.fines || [];
                    
                    // Check if auto fine already exists
                    const existingAutoFine = currentFines.find(fine => fine.type === 'auto');
                    
                    if (existingAutoFine) {
                        // Update existing auto fine
                        existingAutoFine.amount = autoFine;
                        existingAutoFine.timestamp = new Date().toISOString();
                    } else if (autoFine > 0) {
                        // Add new auto fine
                        currentFines.push({
                            amount: autoFine,
                            reason: 'Automatic fine for absences',
                            type: 'auto',
                            date: new Date().toISOString().split('T')[0],
                            timestamp: new Date().toISOString(),
                            id: Date.now().toString()
                        });
                    }
                    
                    // Calculate total fine
                    const totalFine = currentFines.reduce((sum, fine) => sum + fine.amount, 0);
                    
                    updates[`students/${student.roll}/fines`] = currentFines;
                    updates[`students/${student.roll}/totalFine`] = totalFine;
                });
                
                await database.ref().update(updates);
                
                showMessage("Automatic fines calculated successfully!", "success");
                
                // Refresh reports
                generateAttendanceReport();
                
            } catch (error) {
                showMessage("Error calculating automatic fines: " + error.message, "error");
            }
        }
        
        // Mark all fines as paid
        async function markAllFinesPaid() {
            if (confirm("Are you sure you want to mark ALL fines as paid? This action cannot be undone.")) {
                try {
                    showMessage("Marking all fines as paid...", "info");
                    
                    const snapshot = await database.ref('students').once('value');
                    
                    if (snapshot.exists()) {
                        const updates = {};
                        
                        snapshot.forEach(childSnapshot => {
                            const studentRoll = childSnapshot.key;
                            updates[`students/${studentRoll}/totalFine`] = 0;
                            updates[`students/${studentRoll}/fines`] = [];
                        });
                        
                        await database.ref().update(updates);
                        showMessage("All fines marked as paid successfully!", "success");
                        
                        // Refresh reports
                        generateAttendanceReport();
                    }
                    
                } catch (error) {
                    showMessage("Error marking fines as paid: " + error.message, "error");
                }
            }
        }
        
        // ========== DELETE ALL FUNCTIONALITY ==========
        
        // Show confirmation dialog for Delete All
        function showDeleteAllConfirmation() {
            const confirmationDialog = document.createElement('div');
            confirmationDialog.className = 'confirmation-dialog';
            confirmationDialog.innerHTML = `
                <div class="confirmation-box">
                    <h3 style="color: #d32f2f; margin-bottom: 15px;">‚ö†Ô∏è WARNING: Delete All Data</h3>
                    <p style="margin-bottom: 10px; font-size: 16px; line-height: 1.5;">
                        Are you sure you want to delete ALL attendance records, fines, and payment data?
                    </p>
                    <p style="margin-bottom: 20px; color: #d32f2f; font-weight: bold;">
                        This action cannot be undone! Only student information will be preserved.
                    </p>
                    <div class="confirmation-buttons">
                        <button class="confirm-btn" onclick="deleteAllData()">üóëÔ∏è Yes, Delete Everything</button>
                        <button class="cancel-btn" onclick="this.closest('.confirmation-dialog').remove()">‚ùå Cancel</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmationDialog);
        }
        
        // Delete all data (attendance, fines, payments)
        async function deleteAllData() {
            try {
                // Remove confirmation dialog
                document.querySelector('.confirmation-dialog').remove();
                
                showMessage("üîÑ Deleting all data...", "info");
                document.body.classList.add('loading');
                
                // Delete all attendance records
                await database.ref('attendance').remove();
                
                // Reset all fines to 0 and clear fine arrays
                const studentsSnapshot = await database.ref('students').once('value');
                if (studentsSnapshot.exists()) {
                    const updates = {};
                    studentsSnapshot.forEach(childSnapshot => {
                        const studentRoll = childSnapshot.key;
                        updates[`students/${studentRoll}/fine`] = 0;
                        updates[`students/${studentRoll}/fines`] = [];
                        updates[`students/${studentRoll}/totalFine`] = 0;
                        updates[`students/${studentRoll}/payments`] = [];
                        updates[`students/${studentRoll}/remaining`] = 0;
                    });
                    await database.ref().update(updates);
                }
                
                document.body.classList.remove('loading');
                showMessage("‚úÖ All data has been deleted successfully! Student records preserved.", "success");
                
                // Refresh data status
                setTimeout(() => {
                    checkDataStatus();
                }, 1000);
                
            } catch (error) {
                document.body.classList.remove('loading');
                showMessage("‚ùå Error deleting data: " + error.message, "error");
            }
        }
        
        // Check data status
        async function checkDataStatus() {
            try {
                const dataStatus = document.getElementById("dataStatus");
                dataStatus.innerHTML = "<p>Checking data status...</p>";
                
                const studentsSnapshot = await database.ref('students').once('value');
                const attendanceSnapshot = await database.ref('attendance').once('value');
                
                let html = "<table><tr><th>Data Type</th><th>Status</th><th>Count</th></tr>";
                
                // Students count
                const studentCount = studentsSnapshot.exists() ? studentsSnapshot.numChildren() : 0;
                html += `<tr>
                    <td>Students</td>
                    <td>${studentCount > 0 ? '‚úÖ Available' : '‚ùå No Data'}</td>
                    <td>${studentCount}</td>
                </tr>`;
                
                // Attendance records count
                const attendanceCount = attendanceSnapshot.exists() ? attendanceSnapshot.numChildren() : 0;
                html += `<tr>
                    <td>Attendance Records</td>
                    <td>${attendanceCount > 0 ? '‚úÖ Available' : '‚ùå No Data'}</td>
                    <td>${attendanceCount}</td>
                </tr>`;
                
                // Fines data
                let totalFines = 0;
                let studentsWithFines = 0;
                if (studentsSnapshot.exists()) {
                    studentsSnapshot.forEach(childSnapshot => {
                        const student = childSnapshot.val();
                        if (student.totalFine && student.totalFine > 0) {
                            totalFines += student.totalFine;
                            studentsWithFines++;
                        }
                    });
                }
                
                html += `<tr>
                    <td>Active Fines</td>
                    <td>${studentsWithFines > 0 ? 'üí∞ Pending' : '‚úÖ All Paid'}</td>
                    <td>${studentsWithFines} students (Rs ${totalFines})</td>
                </tr>`;
                
                html += "</table>";
                dataStatus.innerHTML = html;
                
            } catch (error) {
                document.getElementById("dataStatus").innerHTML = "<p>Error checking data status: " + error.message + "</p>";
            }
        }
        
        // Show message
        function showMessage(message, type) {
            const messageElement = document.getElementById("message");
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            
            // Auto-hide success messages after 3 seconds
            if (type === "success") {
                setTimeout(() => {
                    messageElement.textContent = "";
                    messageElement.className = "message";
                }, 3000);
            }
        }
        
        // Date change handler
        document.getElementById('attendanceDate').addEventListener('change', function() {
            loadAttendanceData().then(() => {
                displayStudents();
            });
        });
    </script>
</body>
</html>