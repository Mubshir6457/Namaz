<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Attendance System</title>
<style>
body{font-family:Arial,sans-serif;background:#f5fff5;margin:0;padding:0;}
header{background:linear-gradient(to right,#228b22,#d4af37);color:white;text-align:center;padding:1rem;font-size:1.4rem;font-weight:bold;}
nav{display:flex;justify-content:center;flex-wrap:wrap;background:#e8f5e9;border-bottom:2px solid #c5e1a5;}
nav button{margin:5px;padding:10px 18px;border:none;background:#2e7d32;color:white;border-radius:5px;cursor:pointer;}
nav button:hover{background:#1b5e20;}
section{display:none;padding:20px;}
.active{display:block;}
input,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:5px;}
.btn{background:#388e3c;color:white;border:none;padding:8px 14px;border-radius:5px;cursor:pointer;margin-top:5px;}
.btn:hover{background:#2e7d32;}
.btn-danger{background:#d32f2f;}
.btn-danger:hover{background:#b71c1c;}
.btn-pay{background:#1976d2;}
.btn-pay:hover{background:#1565c0;}
.btn-info{background:#0288d1;}
.btn-info:hover{background:#01579b;}
.btn-warning{background:#f57c00;}
.btn-warning:hover{background:#e65100;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#c8e6c9;}
.hidden{display:none;}
.attendance-methods{margin:15px 0;padding:15px;background:#e8f5e9;border-radius:8px;}
.method-btn{width:100%;margin:5px 0;padding:12px;}
.status-btns{display:flex;gap:10px;margin:10px 0;}
.status-btn{flex:1;padding:10px;}
.present{background:#4caf50;}
.absent{background:#f44336;}
.quick-actions{margin:10px 0;}
.bulk-actions{margin:15px 0;padding:10px;background:#fff3e0;border-radius:5px;}
.public-summary{background:#e3f2fd;padding:15px;border-radius:8px;margin:10px 0;}
.summary-item{margin:5px 0;font-size:16px;}
</style>
</head>
<body>

<header>🕌 Faizan-e-Raza Madarsa Attendance Portal</header>

<nav>
  <button onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('addStudentSection')">Add / Delete Student</button>
  <button id="attendanceBtn" class="hidden" onclick="showSection('attendanceSection')">Mark Attendance</button>
  <button id="reportBtn" class="hidden" onclick="showSection('reportSection')">View Report</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
  <button onclick="showSection('publicViewSection')">📅 Public Attendance</button>
</nav>

<!-- 🔐 Admin Login -->
<section id="loginSection" class="active">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- 🧑‍🎓 Add / Delete Student -->
<section id="addStudentSection">
  <h2>Manage Students</h2>
  <input type="text" id="studentName" placeholder="Student Name">
  <input type="text" id="studentRoll" placeholder="Roll Number">
  <button class="btn" onclick="addStudent()">➕ Add Student</button>
  <p id="msg"></p>
  <h3>Existing Students</h3>
  <div id="studentTable"></div>
  <button class="btn" onclick="loadStudentList()">🔄 Refresh List</button>
</section>

<!-- ✅ Mark Attendance -->
<section id="attendanceSection">
  <h2>Mark Attendance - Advanced Methods</h2>
  <input type="date" id="attDate" value="">
  
  <div class="attendance-methods">
    <h3>📋 Attendance Methods</h3>
    
    <!-- Method 1: Traditional List -->
    <button class="btn method-btn" onclick="loadTraditionalMethod()">
      📝 Traditional List Method
    </button>
    
    <!-- Method 2: Quick Mark All -->
    <button class="btn btn-info method-btn" onclick="loadQuickMarkMethod()">
      ⚡ Quick Mark All Method
    </button>
    
    <!-- Method 3: Roll Number Based -->
    <button class="btn btn-warning method-btn" onclick="loadRollNumberMethod()">
      🔢 Roll Number Input Method
    </button>
  </div>

  <!-- Traditional Method -->
  <div id="traditionalMethod" class="hidden">
    <h4>Traditional List Method</h4>
    <button class="btn" onclick="loadStudentsForAttendance()">Load Students List</button>
    <div id="studentList"></div>
  </div>

  <!-- Quick Mark Method -->
  <div id="quickMarkMethod" class="hidden">
    <h4>Quick Mark All Method</h4>
    <div class="quick-actions">
      <button class="btn present" onclick="markAllPresent()">✅ Mark All Present</button>
      <button class="btn absent" onclick="markAllAbsent()">❌ Mark All Absent</button>
    </div>
    <div id="quickMarkList"></div>
  </div>

  <!-- Roll Number Method -->
  <div id="rollNumberMethod" class="hidden">
    <h4>Roll Number Input Method</h4>
    <p>Enter roll numbers of absent students (comma separated):</p>
    <input type="text" id="absentRollNumbers" placeholder="e.g., 101, 105, 108">
    <button class="btn" onclick="markAttendanceByRollNumbers()">Mark Attendance</button>
    <p id="rollMethodMsg"></p>
  </div>

  <button class="btn" onclick="saveAttendance()">💾 Save Attendance</button>
  <p id="attMsg"></p>
</section>

<!-- 📊 Attendance Report -->
<section id="reportSection">
  <h2>Attendance Report & Fines</h2>
  <button class="btn" onclick="generateReport()">📄 Generate Report</button>
  <button class="btn btn-danger" onclick="deleteAllAttendanceAndFines()">🗑️ Delete All Attendance Report & Fines</button>
  <table>
    <thead><tr><th>Roll</th><th>Name</th><th>Present</th><th>Absent</th><th>Total</th><th>%</th><th>Fine (Rs)</th><th>Actions</th></tr></thead>
    <tbody id="reportTable"></tbody>
  </table>
</section>

<!-- 🌍 Public Attendance Viewer -->
<section id="publicViewSection">
  <h2>📅 Public Attendance View</h2>
  <input type="text" id="searchRoll" placeholder="Enter Roll Number">
  <button class="btn" onclick="viewPublicAttendance()">🔍 View Attendance</button>
  <div id="publicOutput"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, remove, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// 🔥 Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Default Admin Code
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });

// Set today's date as default
document.getElementById('attDate').valueAsDate = new Date();

// Global variables
let currentStudents = [];

// Section Switch
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

// 🔐 Admin Login
window.adminLogin=async()=>{
  const code=document.getElementById("adminCode").value.trim();
  const snap=await get(ref(db,"admin/code"));
  const real=snap.exists()?snap.val():"6457";
  if(code===real){
    document.querySelectorAll("#studentBtn,#attendanceBtn,#reportBtn,#logoutBtn").forEach(b=>b.classList.remove("hidden"));
    loginMsg.textContent="✅ Login Successful!";
    showSection("addStudentSection");
    loadStudentList();
  } else loginMsg.textContent="❌ Wrong Admin Code!";
};

// 🚪 Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#attendanceBtn,#reportBtn,#logoutBtn").forEach(b=>b.classList.add("hidden"));
  showSection("loginSection");
};

// 🧑‍🎓 Add Student
window.addStudent=async()=>{
  const name=document.getElementById("studentName").value.trim();
  const roll=document.getElementById("studentRoll").value.trim();
  if(!name || !roll){msg.textContent="⚠ Please fill all fields!";return;}
  await set(ref(db,"students/"+roll),{name,roll});
  msg.textContent="✅ Student Added!";
  studentName.value=studentRoll.value="";
  loadStudentList();
};

// 🔁 Load Student List
window.loadStudentList=async()=>{
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return studentTable.innerHTML="<p>No Students Found!</p>";
  let html="<table><tr><th>Roll</th><th>Name</th><th>Action</th></tr>";
  snap.forEach(s=>{
    const st=s.val();
    html+=`<tr><td>${st.roll}</td><td>${st.name}</td>
      <td><button class='btn' onclick='deleteStudent("${st.roll}")'>🗑️ Delete</button></td></tr>`;
  });
  html+="</table>";
  studentTable.innerHTML=html;
};

// 🗑️ Delete Student
window.deleteStudent=async(roll)=>{
  if(confirm("Are you sure you want to delete this student?")){
    await remove(ref(db,"students/"+roll));
    await remove(ref(db,"fines/"+roll));
    msg.textContent="🗑️ Student deleted!";
    loadStudentList();
  }
};

// Hide all method containers
function hideAllMethods() {
  document.getElementById('traditionalMethod').classList.add('hidden');
  document.getElementById('quickMarkMethod').classList.add('hidden');
  document.getElementById('rollNumberMethod').classList.add('hidden');
}

// 📋 Traditional Method
window.loadTraditionalMethod = () => {
  hideAllMethods();
  document.getElementById('traditionalMethod').classList.remove('hidden');
};

// 📋 Load Students for Traditional Attendance
window.loadStudentsForAttendance=async()=>{
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return studentList.innerHTML="<p>No Students Found!</p>";
  
  currentStudents = [];
  let html=`<table><tr><th>Roll</th><th>Name</th><th>Status</th></tr>`;
  snap.forEach(s=>{
    const st=s.val();
    currentStudents.push(st);
    html+=`<tr><td>${st.roll}</td><td>${st.name}</td>
      <td><select id="att_${st.roll}">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select></td></tr>`;
  });
  html+="</table>";
  studentList.innerHTML=html;
};

// ⚡ Quick Mark Method
window.loadQuickMarkMethod = async () => {
  hideAllMethods();
  document.getElementById('quickMarkMethod').classList.remove('hidden');
  
  const snap = await get(child(ref(db), "students"));
  if (!snap.exists()) return quickMarkList.innerHTML = "<p>No Students Found!</p>";
  
  currentStudents = [];
  let html = `<table><tr><th>Roll</th><th>Name</th><th>Status</th><th>Quick Actions</th></tr>`;
  snap.forEach(s => {
    const st = s.val();
    currentStudents.push(st);
    html += `<tr>
      <td>${st.roll}</td>
      <td>${st.name}</td>
      <td><span id="status_${st.roll}">Present</span></td>
      <td>
        <div class="status-btns">
          <button class="btn present status-btn" onclick="setStudentStatus('${st.roll}', 'Present')">✅</button>
          <button class="btn absent status-btn" onclick="setStudentStatus('${st.roll}', 'Absent')">❌</button>
        </div>
      </td>
    </tr>`;
  });
  html += "</table>";
  quickMarkList.innerHTML = html;
};

// Set individual student status in quick mark method
window.setStudentStatus = (roll, status) => {
  document.getElementById(`status_${roll}`).textContent = status;
  document.getElementById(`status_${roll}`).style.color = status === 'Present' ? 'green' : 'red';
  document.getElementById(`status_${roll}`).style.fontWeight = 'bold';
};

// Mark all students present
window.markAllPresent = () => {
  currentStudents.forEach(student => {
    setStudentStatus(student.roll, 'Present');
  });
};

// Mark all students absent
window.markAllAbsent = () => {
  currentStudents.forEach(student => {
    setStudentStatus(student.roll, 'Absent');
  });
};

// 🔢 Roll Number Method
window.loadRollNumberMethod = () => {
  hideAllMethods();
  document.getElementById('rollNumberMethod').classList.remove('hidden');
};

// Mark attendance by roll numbers
window.markAttendanceByRollNumbers = async () => {
  const absentRollsInput = document.getElementById('absentRollNumbers').value.trim();
  const absentRolls = absentRollsInput.split(',').map(roll => roll.trim()).filter(roll => roll !== '');
  
  const snap = await get(child(ref(db), "students"));
  if (!snap.exists()) {
    document.getElementById('rollMethodMsg').textContent = "❌ No students found!";
    return;
  }
  
  currentStudents = [];
  snap.forEach(s => {
    currentStudents.push(s.val());
  });
  
  // Mark all as present first, then mark specified rolls as absent
  currentStudents.forEach(student => {
    const isAbsent = absentRolls.includes(student.roll);
    if (isAbsent) {
      setStudentStatus(student.roll, 'Absent');
    } else {
      setStudentStatus(student.roll, 'Present');
    }
  });
  
  document.getElementById('rollMethodMsg').textContent = `✅ Attendance marked! ${absentRolls.length} students marked as absent.`;
};

// 💾 Save Attendance (Universal for all methods)
window.saveAttendance=async()=>{
  const date=document.getElementById("attDate").value;
  if(!date)return attMsg.textContent="⚠ Please select a date!";
  
  if(currentStudents.length === 0){
    attMsg.textContent="⚠ Please load students first using one of the methods!";
    return;
  }
  
  const saves=[];
  currentStudents.forEach(student=>{
    let status = "Present"; // default
    
    // Check which method is active and get status accordingly
    if(!document.getElementById('traditionalMethod').classList.contains('hidden')){
      // Traditional method
      const selectElement = document.getElementById("att_"+student.roll);
      if(selectElement) status = selectElement.value;
    } else {
      // Quick mark or roll number method
      const statusElement = document.getElementById("status_"+student.roll);
      if(statusElement) status = statusElement.textContent;
    }
    
    saves.push(set(ref(db,"attendance/"+date+"/"+student.roll),{
      roll:student.roll,
      name:student.name,
      status
    }));
  });
  
  await Promise.all(saves);
  attMsg.textContent="✅ Attendance Saved Successfully!";
  
  // Reset forms
  document.getElementById('absentRollNumbers').value = '';
  document.getElementById('rollMethodMsg').textContent = '';
};

// 📊 Generate Report
window.generateReport=async()=>{
  const stdSnap=await get(child(ref(db),"students"));
  const attSnap=await get(child(ref(db),"attendance"));
  const fineSnap=await get(child(ref(db),"fines"));
  reportTable.innerHTML="";
  if(!stdSnap.exists())return reportTable.innerHTML="<tr><td colspan='8'>No Students</td></tr>";
  stdSnap.forEach(stu=>{
    const s=stu.val();
    let total=0,present=0,absent=0;
    attSnap.forEach(day=>{
      const d=day.val()[s.roll];
      if(d){
        total++;
        if(d.status==="Present")present++; else absent++;
      }
    });
    const percent=total?((present/total)*100).toFixed(1):0;
    
    // Calculate fine: Rs. 10 per absence
    const calculatedFine = absent * 10;
    
    // Get existing fine if any, otherwise use calculated fine
    const fineVal=fineSnap.exists()&&fineSnap.val()[s.roll]?fineSnap.val()[s.roll].amount:calculatedFine;
    
    reportTable.innerHTML+=`
    <tr>
      <td>${s.roll}</td><td>${s.name}</td><td>${present}</td><td>${absent}</td>
      <td>${total}</td><td>${percent}%</td>
      <td><input type='number' id='fine_${s.roll}' value='${fineVal}' placeholder='0' readonly></td>
      <td>
        <button class='btn btn-pay' onclick='payFine("${s.roll}")'>💰 Pay</button>
      </td>
    </tr>`;
  });
};

// 💰 Pay Fine (Reset to zero)
window.payFine=async(roll)=>{
  if(confirm(`Are you sure you want to mark the fine as paid for roll number ${roll}?`)){
    await set(ref(db,"fines/"+roll),{amount:0});
    alert("✅ Fine marked as paid!");
    generateReport(); // Refresh the report
  }
};

// 🗑️ Delete All Attendance and Fines
window.deleteAllAttendanceAndFines=async()=>{
  if(confirm("⚠️ Are you sure you want to delete ALL attendance records and fines? This action cannot be undone!")){
    try {
      await remove(ref(db, "attendance"));
      await remove(ref(db, "fines"));
      alert("✅ All attendance records and fines have been deleted!");
      generateReport(); // Refresh the report table
    } catch (error) {
      alert("❌ Error deleting data: " + error.message);
    }
  }
};

// 🌍 Public Attendance (Simplified - No month required, no status table)
window.viewPublicAttendance=async()=>{
  const roll=document.getElementById("searchRoll").value.trim();
  if(!roll){
    publicOutput.innerHTML="⚠ Please enter Roll Number!";
    return;
  }

  const studentSnap=await get(ref(db,"students/"+roll));
  if(!studentSnap.exists()){
    publicOutput.innerHTML="❌ Invalid Roll Number!";
    return;
  }

  const attSnap=await get(child(ref(db),"attendance"));
  const fineSnap=await get(child(ref(db),"fines/"+roll));
  
  let total=0,present=0,absent=0;
  if(attSnap.exists()){
    attSnap.forEach(day=>{
      const rec=day.val()[roll];
      if(rec){
        total++;
        if(rec.status==="Present")present++; else absent++;
      }
    });
  }

  if(total===0){
    publicOutput.innerHTML="❌ No Attendance Record Found!";
    return;
  }

  // Calculate fine: Rs. 10 per absence
  const calculatedFine = absent * 10;
  // Get existing fine if any, otherwise use calculated fine
  let fine = fineSnap.exists() ? fineSnap.val().amount : calculatedFine;

  const percent=((present/total)*100).toFixed(1);
  
  publicOutput.innerHTML=`
  <div class="public-summary">
    <h3>📘 Attendance Summary</h3>
    <div class="summary-item"><b>Name:</b> ${studentSnap.val().name}</div>
    <div class="summary-item"><b>Roll Number:</b> ${roll}</div>
    <div class="summary-item"><b>Total Days:</b> ${total}</div>
    <div class="summary-item"><b>Present Days:</b> ${present}</div>
    <div class="summary-item"><b>Absent Days:</b> ${absent}</div>
    <div class="summary-item"><b>Attendance Percentage:</b> ${percent}%</div>
    <div class="summary-item"><b>Total Fine:</b> Rs ${fine}</div>
  </div>`;
};
</script>
</body>
</html>