<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Attendance System</title>
<style>
body{font-family:Arial,sans-serif;background:#f5fff5;margin:0;padding:0;}
header{background:linear-gradient(to right,#228b22,#d4af37);color:white;text-align:center;padding:1rem;font-size:1.4rem;font-weight:bold;}
nav{display:flex;justify-content:center;flex-wrap:wrap;background:#e8f5e9;border-bottom:2px solid #c5e1a5;}
nav button{margin:5px;padding:10px 18px;border:none;background:#2e7d32;color:white;border-radius:5px;cursor:pointer;}
nav button:hover{background:#1b5e20;}
section{display:none;padding:20px;}
.active{display:block;}
input,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:5px;}
.btn{background:#388e3c;color:white;border:none;padding:8px 14px;border-radius:5px;cursor:pointer;margin-top:5px;}
.btn:hover{background:#2e7d32;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#c8e6c9;}
.hidden{display:none;}
</style>
</head>
<body>

<header>🕌 Faizan-e-Raza Madarsa Attendance Portal</header>

<nav>
  <button onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('addStudentSection')">Add Student</button>
  <button id="attendanceBtn" class="hidden" onclick="showSection('attendanceSection')">Mark Attendance</button>
  <button onclick="showSection('reportSection')">View Attendance Report</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
</nav>

<!-- 🔐 Admin Login -->
<section id="loginSection" class="active">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- 🧑‍🎓 Add Student -->
<section id="addStudentSection">
  <h2>Add Student</h2>
  <input type="text" id="stuName" placeholder="Student Name">
  <input type="text" id="stuRoll" placeholder="Roll Number">
  <button class="btn" onclick="addStudent()">Add Student</button>
  <p id="msg"></p>
</section>

<!-- ✅ Mark Attendance -->
<section id="attendanceSection">
  <h2>Mark Attendance</h2>
  <input type="date" id="attDate">
  <button class="btn" onclick="loadStudents()">Load Students</button>
  <div id="studentList"></div>
  <button class="btn" onclick="saveAttendance()">💾 Save Attendance</button>
  <p id="attMsg"></p>
</section>

<!-- 📊 Attendance Report -->
<section id="reportSection">
  <h2>Attendance Report</h2>
  <button class="btn" onclick="generateReport()">📄 Generate Report</button>
  <table>
    <thead><tr><th>Roll</th><th>Name</th><th>Present</th><th>Absent</th><th>Total Days</th><th>% Attendance</th></tr></thead>
    <tbody id="reportTable"></tbody>
  </table>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// 🔥 Firebase Setup
const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Default Admin Code
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });

// Section Switch
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

// 🔐 Admin Login
window.adminLogin=async()=>{
  const code=document.getElementById("adminCode").value.trim();
  const snap=await get(ref(db,"admin/code"));
  const real=snap.exists()?snap.val():"6457";
  if(code===real){
    document.querySelectorAll("#studentBtn,#attendanceBtn,#logoutBtn").forEach(b=>b.classList.remove("hidden"));
    loginMsg.textContent="✅ Login Successful!";
    showSection("addStudentSection");
  } else loginMsg.textContent="❌ Wrong Admin Code!";
};

// 🚪 Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#attendanceBtn,#logoutBtn").forEach(b=>b.classList.add("hidden"));
  showSection("loginSection");
};

// ➕ Add Student
window.addStudent=async()=>{
  const name=document.getElementById("stuName").value.trim();
  const roll=document.getElementById("stuRoll").value.trim();
  if(!name||!roll) return document.getElementById("msg").textContent="⚠ Please fill all fields!";
  await set(ref(db,"students/"+roll),{name:name,roll:roll});
  document.getElementById("msg").textContent="✅ Student Added Successfully!";
  document.getElementById("stuName").value="";
  document.getElementById("stuRoll").value="";
};

// 📋 Load Students for Attendance
window.loadStudents=async()=>{
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return studentList.innerHTML="<p>No Students Found!</p>";
  let html=`<table><tr><th>Roll</th><th>Name</th><th>Status</th></tr>`;
  snap.forEach(s=>{
    const st=s.val();
    html+=`<tr><td>${st.roll}</td><td>${st.name}</td>
    <td><select id="att_${st.roll}">
      <option value="Present">Present</option>
      <option value="Absent">Absent</option>
    </select></td></tr>`;
  });
  html+="</table>";
  studentList.innerHTML=html;
};

// 💾 Save Attendance
window.saveAttendance=async()=>{
  const date=document.getElementById("attDate").value;
  if(!date)return attMsg.textContent="⚠ Select Date!";
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return attMsg.textContent="⚠ No Students!";
  const saves=[];
  snap.forEach(s=>{
    const st=s.val();
    const status=document.getElementById("att_"+st.roll).value;
    saves.push(set(ref(db,"attendance/"+date+"/"+st.roll),{roll:st.roll,name:st.name,status}));
  });
  await Promise.all(saves);
  attMsg.textContent="✅ Attendance Saved!";
};

// 📊 Generate Attendance Report
window.generateReport=async()=>{
  const stdSnap=await get(child(ref(db),"students"));
  const attSnap=await get(child(ref(db),"attendance"));
  reportTable.innerHTML="";
  if(!stdSnap.exists())return reportTable.innerHTML="<tr><td colspan='6'>No Students</td></tr>";
  if(!attSnap.exists())return reportTable.innerHTML="<tr><td colspan='6'>No Attendance Data</td></tr>";
  stdSnap.forEach(stu=>{
    const s=stu.val();
    let total=0,present=0,absent=0;
    attSnap.forEach(day=>{
      const d=day.val()[s.roll];
      if(d){
        total++;
        if(d.status==="Present")present++; else absent++;
      }
    });
    const percent=total?((present/total)*100).toFixed(1):0;
    reportTable.innerHTML+=`<tr><td>${s.roll}</td><td>${s.name}</td><td>${present}</td><td>${absent}</td><td>${total}</td><td>${percent}%</td></tr>`;
  });
};
</script>
</body>
</html>
