<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Attendance System</title>
<style>
body{font-family:Arial,sans-serif;background:#f5fff5;margin:0;padding:0;}
header{background:linear-gradient(to right,#228b22,#d4af37);color:white;text-align:center;padding:1rem;font-size:1.4rem;font-weight:bold;}
nav{display:flex;justify-content:center;flex-wrap:wrap;background:#e8f5e9;border-bottom:2px solid #c5e1a5;}
nav button{margin:5px;padding:10px 18px;border:none;background:#2e7d32;color:white;border-radius:5px;cursor:pointer;}
nav button:hover{background:#1b5e20;}
section{display:none;padding:20px;}
.active{display:block;}
input,select{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:5px;}
.btn{background:#388e3c;color:white;border:none;padding:8px 14px;border-radius:5px;cursor:pointer;margin-top:5px;}
.btn:hover{background:#2e7d32;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#c8e6c9;}
.hidden{display:none;}
</style>
</head>
<body>

<header>ğŸ•Œ Faizan-e-Raza Madarsa Attendance Portal</header>

<nav>
  <button onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('addStudentSection')">Add / Delete Student</button>
  <button id="attendanceBtn" class="hidden" onclick="showSection('attendanceSection')">Mark Attendance</button>
  <button id="deleteAttBtn" class="hidden" onclick="showSection('deleteAttendanceSection')">Delete Attendance</button>
  <button id="reportBtn" class="hidden" onclick="showSection('reportSection')">View Report</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
  <button onclick="showSection('publicViewSection')">ğŸ“… Public Attendance</button>
</nav>

<!-- ğŸ” Admin Login -->
<section id="loginSection" class="active">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- ğŸ§‘â€ğŸ“ Add / Delete Student -->
<section id="addStudentSection">
  <h2>Manage Students</h2>
  <input type="text" id="studentName" placeholder="Student Name">
  <input type="text" id="studentRoll" placeholder="Roll Number">
  <button class="btn" onclick="addStudent()">â• Add Student</button>
  <p id="msg"></p>
  <h3>Existing Students</h3>
  <div id="studentTable"></div>
  <button class="btn" onclick="loadStudentList()">ğŸ”„ Refresh List</button>
</section>

<!-- âœ… Mark Attendance -->
<section id="attendanceSection">
  <h2>Mark Attendance</h2>
  <input type="date" id="attDate">
  <button class="btn" onclick="loadStudentsForAttendance()">Load Students</button>
  <div id="studentList"></div>
  <button class="btn" onclick="saveAttendance()">ğŸ’¾ Save Attendance</button>
  <p id="attMsg"></p>
</section>

<!-- ğŸ—‘ï¸ Delete Attendance -->
<section id="deleteAttendanceSection">
  <h2>ğŸ—“ï¸ Delete Attendance by Date</h2>
  <input type="date" id="deleteDate">
  <button class="btn" onclick="deleteAttendance()">ğŸ—‘ï¸ Delete Attendance</button>
  <p id="deleteMsg"></p>
</section>

<!-- ğŸ“Š Attendance Report -->
<section id="reportSection">
  <h2>Attendance Report & Fines</h2>
  <button class="btn" onclick="generateReport()">ğŸ“„ Generate Report</button>
  <table>
    <thead><tr><th>Roll</th><th>Name</th><th>Present</th><th>Absent</th><th>Total</th><th>%</th><th>Fine (Rs)</th><th>Action</th></tr></thead>
    <tbody id="reportTable"></tbody>
  </table>
</section>

<!-- ğŸŒ Public Attendance Viewer -->
<section id="publicViewSection">
  <h2>ğŸ“… Public Attendance View</h2>
  <input type="text" id="searchRoll" placeholder="Enter Roll Number">
  <input type="month" id="searchMonth">
  <button class="btn" onclick="viewPublicAttendance()">ğŸ” View Attendance</button>
  <div id="publicOutput"></div>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, remove, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ğŸ”¥ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Default Admin Code
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });

// Section Switch
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

// ğŸ” Admin Login
window.adminLogin=async()=>{
  const code=document.getElementById("adminCode").value.trim();
  const snap=await get(ref(db,"admin/code"));
  const real=snap.exists()?snap.val():"6457";
  if(code===real){
    document.querySelectorAll("#studentBtn,#attendanceBtn,#reportBtn,#logoutBtn,#deleteAttBtn").forEach(b=>b.classList.remove("hidden"));
    loginMsg.textContent="âœ… Login Successful!";
    showSection("addStudentSection");
    loadStudentList();
  } else loginMsg.textContent="âŒ Wrong Admin Code!";
};

// ğŸšª Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#attendanceBtn,#reportBtn,#logoutBtn,#deleteAttBtn").forEach(b=>b.classList.add("hidden"));
  showSection("loginSection");
};

// ğŸ§‘â€ğŸ“ Add Student
window.addStudent=async()=>{
  const name=document.getElementById("studentName").value.trim();
  const roll=document.getElementById("studentRoll").value.trim();
  if(!name || !roll){msg.textContent="âš  Please fill all fields!";return;}
  await set(ref(db,"students/"+roll),{name,roll});
  msg.textContent="âœ… Student Added!";
  studentName.value=studentRoll.value="";
  loadStudentList();
};

// ğŸ” Load Student List
window.loadStudentList=async()=>{
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return studentTable.innerHTML="<p>No Students Found!</p>";
  let html="<table><tr><th>Roll</th><th>Name</th><th>Action</th></tr>";
  snap.forEach(s=>{
    const st=s.val();
    html+=`<tr><td>${st.roll}</td><td>${st.name}</td>
      <td><button class='btn' onclick='deleteStudent("${st.roll}")'>ğŸ—‘ï¸ Delete</button></td></tr>`;
  });
  html+="</table>";
  studentTable.innerHTML=html;
};

// ğŸ—‘ï¸ Delete Student
window.deleteStudent=async(roll)=>{
  if(confirm("Are you sure you want to delete this student?")){
    await remove(ref(db,"students/"+roll));
    await remove(ref(db,"fines/"+roll));
    msg.textContent="ğŸ—‘ï¸ Student deleted!";
    loadStudentList();
  }
};

// ğŸ“‹ Load Students for Attendance
window.loadStudentsForAttendance=async()=>{
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return studentList.innerHTML="<p>No Students Found!</p>";
  let html=`<table><tr><th>Roll</th><th>Name</th><th>Status</th></tr>`;
  snap.forEach(s=>{
    const st=s.val();
    html+=`<tr><td>${st.roll}</td><td>${st.name}</td>
      <td><select id="att_${st.roll}">
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
      </select></td></tr>`;
  });
  html+="</table>";
  studentList.innerHTML=html;
};

// ğŸ’¾ Save Attendance
window.saveAttendance=async()=>{
  const date=document.getElementById("attDate").value;
  if(!date)return attMsg.textContent="âš  Please select a date!";
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return attMsg.textContent="âš  No Students!";
  const saves=[];
  snap.forEach(s=>{
    const st=s.val();
    const status=document.getElementById("att_"+st.roll).value;
    saves.push(set(ref(db,"attendance/"+date+"/"+st.roll),{roll:st.roll,name:st.name,status}));
  });
  await Promise.all(saves);
  attMsg.textContent="âœ… Attendance Saved!";
};

// ğŸ—‘ï¸ Delete Attendance by Date
window.deleteAttendance=async()=>{
  const date=document.getElementById("deleteDate").value;
  if(!date)return deleteMsg.textContent="âš  Please select a date!";
  await remove(ref(db,"attendance/"+date));
  deleteMsg.textContent="ğŸ—‘ï¸ Attendance deleted for "+date;
};

// ğŸ“Š Generate Report
window.generateReport=async()=>{
  const stdSnap=await get(child(ref(db),"students"));
  const attSnap=await get(child(ref(db),"attendance"));
  const fineSnap=await get(child(ref(db),"fines"));
  reportTable.innerHTML="";
  if(!stdSnap.exists())return reportTable.innerHTML="<tr><td colspan='8'>No Students</td></tr>";
  stdSnap.forEach(stu=>{
    const s=stu.val();
    let total=0,present=0,absent=0;
    attSnap.forEach(day=>{
      const d=day.val()[s.roll];
      if(d){
        total++;
        if(d.status==="Present")present++; else absent++;
      }
    });
    const percent=total?((present/total)*100).toFixed(1):0;
    const fineVal=fineSnap.exists()&&fineSnap.val()[s.roll]?fineSnap.val()[s.roll].amount:"";
    reportTable.innerHTML+=`
    <tr>
      <td>${s.roll}</td><td>${s.name}</td><td>${present}</td><td>${absent}</td>
      <td>${total}</td><td>${percent}%</td>
      <td><input type='number' id='fine_${s.roll}' value='${fineVal||""}' placeholder='0'></td>
      <td><button class='btn' onclick='saveFine("${s.roll}")'>ğŸ’° Save</button></td>
    </tr>`;
  });
};

// ğŸ’° Save Fine
window.saveFine=async(roll)=>{
  const fine=document.getElementById("fine_"+roll).value||0;
  await set(ref(db,"fines/"+roll),{amount:fine});
  alert("âœ… Fine Updated!");
};

// ğŸŒ Public Attendance (with fine shown)
window.viewPublicAttendance=async()=>{
  const roll=document.getElementById("searchRoll").value.trim();
  const month=document.getElementById("searchMonth").value;
  if(!roll || !month){publicOutput.innerHTML="âš  Enter Roll & Month!";return;}

  const studentSnap=await get(ref(db,"students/"+roll));
  if(!studentSnap.exists()){
    publicOutput.innerHTML="âŒ Invalid Roll Number!";
    return;
  }

  const attSnap=await get(child(ref(db),"attendance"));
  const fineSnap=await get(child(ref(db),"fines/"+roll));
  let fine=fineSnap.exists()?fineSnap.val().amount:0;
  let total=0,present=0,absent=0,rows="";
  if(attSnap.exists()){
    attSnap.forEach(day=>{
      const dateKey=day.key;
      if(dateKey.startsWith(month)){
        const rec=day.val()[roll];
        if(rec){
          total++;
          if(rec.status==="Present")present++; else absent++;
          rows+=`<tr><td>${dateKey}</td><td>${rec.status}</td></tr>`;
        }
      }
    });
  }

  if(total===0){
    publicOutput.innerHTML="âŒ No Attendance Record Found!";
    return;
  }

  const percent=((present/total)*100).toFixed(1);
  publicOutput.innerHTML=`
  <h3>ğŸ“˜ Attendance Report</h3>
  <p><b>Name:</b> ${studentSnap.val().name}</p>
  <p><b>Roll:</b> ${roll}</p>
  <p><b>Month:</b> ${month}</p>
  <p><b>Present:</b> ${present}</p>
  <p><b>Absent:</b> ${absent}</p>
  <p><b>Total Days:</b> ${total}</p>
  <p><b>Attendance %:</b> ${percent}%</p>
  <p><b>Fine:</b> Rs ${fine}</p>
  <table><thead><tr><th>Date</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table>`;
};
</script>
</body>
</html>
